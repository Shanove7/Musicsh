<!DOCTYPE html>
<html lang="id" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>XyonGPT Interface</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
fontFamily: {
sans: ['Plus Jakarta Sans', 'sans-serif'],
mono: ['JetBrains Mono', 'monospace'],
},
colors: {
primary: '#6366f1',
secondary: '#8b5cf6',
dark: '#0f172a',
surface: '#1e293b',
},
animation: {
'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
'fade-in': 'fadeIn 0.3s ease-out forwards',
},
keyframes: {
slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
}
}
}
}
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
html, body { height: 100%; height: 100dvh; overflow: hidden; overscroll-behavior: none; }
body { transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
.glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-right: 1px solid rgba(0,0,0,0.05); }
.dark .glass-panel { background: rgba(15, 23, 42, 0.7); border-right: 1px solid rgba(255,255,255,0.05); }
.glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-top: 1px solid rgba(0,0,0,0.05); }
.dark .glass-nav { background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255,255,255,0.05); }
.msg-user { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25); }
.msg-ai { border-radius: 18px 18px 18px 4px; }
.dark .msg-ai { background: #1e293b; border: 1px solid rgba(255,255,255,0.05); color: #e2e8f0; }
.light .msg-ai { background: #ffffff; border: 1px solid rgba(0,0,0,0.05); color: #334155; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.typing span { display: inline-block; width: 5px; height: 5px; background-color: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
.typing span:nth-child(1) { animation-delay: -0.32s; }
.typing span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
.code-header { border-radius: 8px 8px 0 0; background: #282c34; display: flex; justify-content: space-between; padding: 6px 12px; font-size: 0.75rem; color: #abb2bf; align-items: center; }
pre { margin: 0 !important; border-radius: 0 0 8px 8px !important; }
canvas#neural { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; pointer-events: none; }
</style>
</head>
<body class="bg-slate-50 dark:bg-dark text-slate-800 dark:text-slate-200 selection:bg-primary selection:text-white flex h-full w-full">

<canvas id="neural"></canvas>

<div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>

<aside id="sidebar" class="fixed md:relative inset-y-0 left-0 z-50 w-[280px] h-full glass-panel transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl md:shadow-none">
<div class="p-6 flex items-center justify-between border-b dark:border-white/5 border-black/5">
<div class="flex items-center gap-3">
<img src="https://ibb.co.com/mVSz8MQM" class="w-10 h-10 rounded-xl shadow-lg shadow-primary/20 object-cover border border-white/10" alt="Logo">
<div>
<h1 class="font-bold text-xl tracking-tight font-sans">Xyon<span class="text-primary">GPT</span></h1>
<span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest flex items-center gap-1.5">
<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
<span>Online</span>
</span>
</div>
</div>
<button class="md:hidden text-gray-400 hover:text-primary transition-colors" onclick="toggleSidebar()"><i class="fa-solid fa-xmark text-xl"></i></button>
</div>

<div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
<div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-3 mb-2 mt-2 opacity-70">Menu</div>
<button onclick="switchTab('chat')" id="nav-chat" class="w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all group relative overflow-hidden bg-primary/10 text-primary font-medium border border-primary/10">
<i class="fa-solid fa-message w-5 text-center"></i> <span class="text-sm">Chat</span>
</button>
<button onclick="switchTab('history')" id="nav-history" class="w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all text-gray-500 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white">
<i class="fa-solid fa-clock-rotate-left w-5 text-center"></i> <span class="text-sm">History</span>
</button>
<button onclick="switchTab('docs')" id="nav-docs" class="w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all text-gray-500 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white">
<i class="fa-solid fa-book-open-reader w-5 text-center"></i> <span class="text-sm">API</span>
</button>
<div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-3 mb-2 mt-6 opacity-70">System</div>
<button onclick="switchTab('owner')" id="nav-owner" class="w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all text-gray-500 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white">
<i class="fa-solid fa-fingerprint w-5 text-center"></i> <span class="text-sm">About</span>
</button>
</div>

<div class="p-4 border-t dark:border-white/5 border-black/5 bg-gray-50/50 dark:bg-black/20">
<div class="bg-white/50 dark:bg-white/5 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:border-primary border border-transparent transition-all group" onclick="editProfile()">
<img id="userAvatarImg" src="" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200 dark:border-gray-700 group-hover:border-primary transition-colors">
<div class="flex-1 overflow-hidden">
<p id="userNameDisplay" class="text-sm font-bold truncate group-hover:text-primary transition-colors">User</p>
<p class="text-[10px] text-gray-500 truncate">Settings</p>
</div>
<i class="fa-solid fa-gear text-xs text-gray-400 group-hover:text-primary transition-all"></i>
</div>
</div>
</aside>

<main class="flex-1 flex flex-col h-full w-full relative min-w-0">
<header class="h-16 flex-none flex items-center justify-between px-4 sticky top-0 z-30 bg-white/80 dark:bg-dark/80 backdrop-blur-md border-b dark:border-white/5 border-black/5">
<div class="flex items-center gap-3">
<button class="md:hidden w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 dark:hover:bg-white/5 text-gray-500 transition-colors" onclick="toggleSidebar()">
<i class="fa-solid fa-bars-staggered text-lg"></i>
</button>
<div>
<h2 id="pageTitle" class="font-bold tracking-tight text-lg leading-tight">Terminal</h2>
</div>
</div>
<div class="flex items-center gap-2">
<button onclick="toggleTheme()" class="w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center transition-all group">
<i class="fa-solid fa-sun text-amber-400 text-lg hidden dark:block group-hover:rotate-90 transition-transform"></i>
<i class="fa-solid fa-moon text-primary text-lg block dark:hidden group-hover:-rotate-12 transition-transform"></i>
</button>
<button onclick="clearChat()" class="w-10 h-10 rounded-xl hover:bg-red-50 dark:hover:bg-red-500/10 flex items-center justify-center text-gray-400 hover:text-red-500 transition-all">
<i class="fa-solid fa-trash-can text-lg"></i>
</button>
</div>
</header>

<div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden h-full">
<div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth space-y-6">
<div id="welcome" class="h-full flex flex-col items-center justify-center text-center px-4 animate-fade-in pb-10">
<div class="relative group cursor-default mb-6">
<div class="absolute inset-0 bg-primary/30 blur-[40px] opacity-40 group-hover:opacity-60 transition-opacity duration-1000"></div>
<img src="https://ibb.co.com/mVSz8MQM" class="w-32 h-32 rounded-3xl border border-white/10 shadow-2xl relative z-10 animate-fade-in object-cover" alt="Big Logo">
</div>
<h1 class="text-3xl md:text-5xl font-bold tracking-tighter mb-2">Xyon<span class="text-primary">GPT</span></h1>
<p class="text-gray-500 max-w-sm mx-auto text-sm leading-relaxed mb-8">
Advanced Vision AI.
<br>Created by <span class="font-bold text-primary">Kasan</span>.
</p>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-md">
<button onclick="presetPrompt('Analisis gambar ini secara detail')" class="p-4 rounded-xl text-left hover:border-primary/50 transition-all group bg-white/60 dark:bg-white/5 border border-transparent shadow-sm">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary"><i class="fa-solid fa-eye"></i></div>
<div><div class="font-bold text-sm">Vision</div><div class="text-[10px] text-gray-500">Analyze Image</div></div>
</div>
</button>
<button onclick="presetPrompt('Buatkan kode Python untuk Data Science')" class="p-4 rounded-xl text-left hover:border-secondary/50 transition-all group bg-white/60 dark:bg-white/5 border border-transparent shadow-sm">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-lg bg-secondary/10 flex items-center justify-center text-secondary"><i class="fa-solid fa-code"></i></div>
<div><div class="font-bold text-sm">Coding</div><div class="text-[10px] text-gray-500">Generate Code</div></div>
</div>
</button>
</div>
</div>
</div>

<div class="flex-none p-4 z-20 glass-nav">
<div class="max-w-4xl mx-auto flex flex-col gap-3">
<div id="imagePreviewArea" class="px-4 py-2 flex items-center gap-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-200 dark:border-white/10 animate-slide-up" style="display:none;">
<div class="relative w-12 h-12 rounded-lg overflow-hidden group border border-primary/30">
<img id="previewImg" src="" class="w-full h-full object-cover">
<div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer text-white" onclick="removeImage()">
<i class="fa-solid fa-xmark"></i>
</div>
</div>
<div class="flex flex-col">
<span class="text-xs font-bold text-primary">Image Attached</span>
<span class="text-[10px] text-gray-500">Ready for visual analysis</span>
</div>
</div>
<form id="chatForm" class="flex items-end gap-2">
<input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
<button type="button" onclick="document.getElementById('imageInput').click()" class="p-3 w-12 h-12 flex items-center justify-center text-gray-500 hover:text-primary hover:bg-primary/10 rounded-xl transition-all flex-shrink-0" title="Upload Image">
<i class="fa-solid fa-paperclip text-lg"></i>
</button>
<div class="flex-1 relative bg-gray-100 dark:bg-black/30 rounded-2xl border border-transparent focus-within:border-primary/50 transition-all">
<textarea id="userInput" rows="1" class="w-full bg-transparent dark:text-white text-gray-900 px-4 py-3 focus:outline-none placeholder-gray-400 resize-none text-sm max-h-32" placeholder="Tanya sesuatu..."></textarea>
</div>
<button type="button" id="micBtn" onclick="toggleMic()" class="p-3 w-12 h-12 flex items-center justify-center text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-xl transition-all flex-shrink-0">
<i class="fa-solid fa-microphone text-lg"></i>
</button>
<button type="submit" id="sendBtn" class="p-3 w-12 h-12 flex items-center justify-center bg-primary hover:bg-secondary text-white rounded-xl shadow-lg shadow-primary/20 transition-all active:scale-95 flex-shrink-0">
<i class="fa-solid fa-paper-plane text-lg"></i>
</button>
</form>
</div>
</div>
</div>

<div id="view-history" class="hidden h-full overflow-y-auto p-6 md:p-10 custom-scrollbar animate-fade-in">
<div class="max-w-4xl mx-auto">
<div class="flex justify-between items-center mb-8">
<h2 class="text-2xl font-bold flex items-center gap-3 dark:text-white text-gray-800"><i class="fa-solid fa-database text-primary"></i> Chat Logs</h2>
<button onclick="wipeHistory()" class="text-xs text-red-500 hover:bg-red-500/10 px-4 py-2 rounded-lg transition-colors border border-red-500/20 font-bold">CLEAR</button>
</div>
<div id="historyList" class="grid grid-cols-1 gap-4"></div>
</div>
</div>

<div id="view-docs" class="hidden h-full overflow-y-auto p-6 md:p-10 custom-scrollbar animate-fade-in">
<div class="max-w-5xl mx-auto">
<div class="p-8 rounded-3xl bg-white/60 dark:bg-black/40 border border-white/10">
<div class="flex items-center gap-4 mb-8">
<img src="https://ibb.co.com/mVSz8MQM" class="w-12 h-12 rounded-xl object-cover shadow-lg" alt="Doc Logo">
<div><h2 class="text-2xl font-bold dark:text-white text-gray-900">API Docs</h2><p class="text-gray-500 text-sm">Integration Protocol</p></div>
</div>
<div class="space-y-8">
<div class="group relative">
<div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-primary uppercase tracking-wider">Endpoint</span><span class="px-2 py-0.5 rounded text-[10px] bg-green-500/10 text-green-500 border border-green-500/20 font-bold font-mono">POST</span></div>
<div class="p-4 rounded-xl dark:bg-[#0b0c10] bg-gray-100 border dark:border-white/10 border-gray-200 font-mono text-xs md:text-sm flex justify-between items-center text-gray-600 dark:text-gray-300">
<span class="truncate">https://xyongpt.my.id/api/index</span>
<button onclick="copyText('https://xyongpt.my.id/api/index')" class="text-gray-400 hover:text-primary"><i class="fa-regular fa-copy text-lg"></i></button>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div>
<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-arrow-right-to-bracket text-xs text-blue-400"></i><span class="text-xs font-bold text-gray-500 uppercase">Request</span></div>
<div class="rounded-xl overflow-hidden border dark:border-white/10 border-gray-200"><pre><code class="language-json hljs" style="background:transparent; padding:1rem;">{ "prompt": "Halo Xyon!" }</code></pre></div>
</div>
<div>
<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-arrow-right-from-bracket text-xs text-green-400"></i><span class="text-xs font-bold text-gray-500 uppercase">Response</span></div>
<div class="rounded-xl overflow-hidden border dark:border-white/10 border-gray-200"><pre><code class="language-json hljs" style="background:transparent; padding:1rem;">{
  "status": true,
  "data": { "answer": "..." }
}</code></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="view-owner" class="hidden h-full overflow-y-auto p-8 flex items-center justify-center custom-scrollbar animate-fade-in">
<div class="p-1 rounded-[32px] max-w-sm w-full relative group hover:-translate-y-2 transition-transform duration-500 bg-gradient-to-tr from-primary/20 to-secondary/20">
<div class="bg-white dark:bg-[#0b0c10] rounded-[30px] p-8 relative z-10 text-center overflow-hidden h-full border dark:border-white/5 border-gray-100">
<div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-primary/10 to-transparent"></div>
<div class="relative z-10">
<div class="w-32 h-32 mx-auto p-1.5 rounded-full bg-gradient-to-r from-primary to-secondary mb-6 shadow-2xl shadow-primary/30">
<img src="https://ui-avatars.com/api/?name=Kasan&background=000&color=fff&size=256" class="w-full h-full rounded-full object-cover border-4 dark:border-[#0b0c10] border-white">
<div class="absolute bottom-2 right-2 w-8 h-8 bg-blue-500 border-4 dark:border-[#0b0c10] border-white rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-check"></i></div>
</div>
<h2 class="text-3xl font-bold mb-1 dark:text-white text-gray-900">Kasan</h2>
<p class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary font-bold text-xs uppercase tracking-widest mb-6">Developer</p>
<p class="text-gray-500 text-sm mb-8 leading-relaxed px-2">"Forging the future of AI interaction. XyonGPT is the culmination of this vision."</p>
<div class="flex justify-center gap-4">
<a href="#" class="p-3 bg-gray-100 dark:bg-white/5 rounded-2xl hover:bg-black hover:text-white transition-all text-gray-600 dark:text-gray-400"><i class="fa-brands fa-github text-xl"></i></a>
<a href="#" class="p-3 bg-gray-100 dark:bg-white/5 rounded-2xl hover:bg-green-600 hover:text-white transition-all text-gray-600 dark:text-gray-400"><i class="fa-brands fa-whatsapp text-xl"></i></a>
</div>
</div>
</div>
</div>
</div>
</main>

<script>
const API_URL = 'https://xyongpt.my.id/api/index';
let defaultAvatar = "https://ui-avatars.com/api/?name=User&background=6366f1&color=fff";
let userName = localStorage.getItem('xyon_username') || 'User';
let userAvatar = localStorage.getItem('xyon_avatar') || defaultAvatar;
let currentImageBase64 = null;
let isGenerating = false;
let voices = [];

window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };

const html = document.documentElement;
function initTheme() {
    const theme = localStorage.getItem('xyon_theme') || 'dark';
    html.className = theme;
    drawNeuralNetwork();
}
function toggleTheme() {
    const newTheme = html.classList.contains('dark') ? 'light' : 'dark';
    html.className = newTheme;
    localStorage.setItem('xyon_theme', newTheme);
    drawNeuralNetwork();
}
function updateProfileUI() {
    document.getElementById('userAvatarImg').src = userAvatar;
    document.getElementById('userNameDisplay').innerText = userName;
}
function editProfile() {
    const n = prompt("Username:", userName); if(n) { userName=n; localStorage.setItem('xyon_username', n); }
    const a = prompt("Avatar URL:", userAvatar); if(a) { userAvatar=a; localStorage.setItem('xyon_avatar', a); }
    updateProfileUI();
}

const sidebar = document.getElementById('sidebar');
const mobileOverlay = document.getElementById('mobileOverlay');

function toggleSidebar() {
    sidebar.classList.toggle('-translate-x-full');
    mobileOverlay.classList.toggle('hidden');
}

function switchTab(tab) {
    ['chat', 'history', 'docs', 'owner'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
    document.querySelectorAll('#sidebar button').forEach(b => {
        b.classList.remove('bg-primary/10', 'text-primary', 'font-medium', 'border-primary/10');
        b.classList.add('text-gray-500');
    });
    
    document.getElementById(`view-${tab}`).classList.remove('hidden');
    const activeBtn = document.getElementById(`nav-${tab}`);
    activeBtn.classList.remove('text-gray-500');
    activeBtn.classList.add('bg-primary/10', 'text-primary', 'font-medium', 'border-primary/10');
    
    document.getElementById('pageTitle').innerText = tab === 'chat' ? 'Terminal' : tab.charAt(0).toUpperCase() + tab.slice(1);
    
    if(window.innerWidth < 768) {
        sidebar.classList.add('-translate-x-full');
        mobileOverlay.classList.add('hidden');
    }
    if(tab === 'history') loadHistory();
}

const userInput = document.getElementById('userInput');
userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
userInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });

function handleImageSelect(input) { if (input.files[0]) processImage(input.files[0]); }
function processImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('previewImg').src = e.target.result;
        document.getElementById('imagePreviewArea').style.display = 'flex';
        currentImageBase64 = e.target.result;
    };
    reader.readAsDataURL(file);
}
function removeImage() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreviewArea').style.display = 'none';
    currentImageBase64 = null;
}
function handleDragOver(e) { e.preventDefault(); }
function handleDragLeave(e) { e.preventDefault(); }
function handleDrop(e) {
    e.preventDefault();
    if(e.dataTransfer.files[0]?.type.startsWith('image/')) processImage(e.dataTransfer.files[0]);
}

function appendMessage(role, text, image = null) {
    document.getElementById('welcome').style.display = 'none';
    const div = document.createElement('div');
    div.className = `flex w-full mb-6 ${role === 'user' ? 'justify-end' : 'justify-start'} animate-slide-up`;
    const imgHtml = image ? `<img src="${image}" class="max-w-[200px] rounded-xl mb-2 border border-white/20 shadow-md">` : '';
    const avatar = role === 'user' ? userAvatar : 'https://ibb.co.com/mVSz8MQM';
    
    let content = '';
    if (role === 'user') {
        content = `<div class="flex items-end gap-3 max-w-[85%]"><div class="msg-user p-4 text-sm shadow-md leading-relaxed">${imgHtml}<div class="whitespace-pre-wrap font-medium">${text}</div></div><img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-200 dark:border-white/10 shadow-sm object-cover"></div>`;
    } else {
        content = `<div class="flex items-start gap-3 max-w-[95%] lg:max-w-[85%]"><img src="${avatar}" class="w-9 h-9 rounded-xl mt-1 shadow-sm object-cover"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-primary">XyonGPT</span><span class="text-[9px] text-gray-400 border border-gray-300 dark:border-gray-700 px-1.5 rounded font-mono">BOT</span></div><div class="msg-ai p-5 shadow-sm overflow-hidden bg-white/60 dark:bg-white/5"><div class="prose prose-sm max-w-none dark:prose-invert prose-p:leading-relaxed prose-pre:bg-[#1e1e24] prose-pre:border prose-pre:border-white/5">${marked.parse(text)}</div></div><div class="flex gap-4 mt-2 ml-1"><button onclick="copyText(this.closest('.flex-1').querySelector('.prose').innerText)" class="text-[10px] text-gray-400 hover:text-primary flex gap-1 items-center transition-colors"><i class="fa-regular fa-copy"></i> Copy</button><button onclick="speak(this.closest('.flex-1').querySelector('.prose').innerText)" class="text-[10px] text-gray-400 hover:text-primary flex gap-1 items-center transition-colors"><i class="fa-solid fa-volume-high"></i> Listen</button></div></div></div>`;
    }
    
    div.innerHTML = content;
    document.getElementById('chatContainer').appendChild(div);
    div.querySelectorAll('pre code').forEach(el => { hljs.highlightElement(el); addCodeHeader(el); });
    document.getElementById('chatContainer').scrollTo({top: document.getElementById('chatContainer').scrollHeight, behavior: 'smooth'});
}

function addCodeHeader(block) {
    const pre = block.parentElement;
    const lang = block.className.replace('hljs language-', '') || 'Text';
    const header = document.createElement('div');
    header.className = 'code-header';
    header.innerHTML = `<span class="font-bold flex items-center gap-2 uppercase"><i class="fa-solid fa-code text-primary"></i> ${lang}</span><button onclick="copyText(this.parentElement.nextElementSibling.innerText)" class="hover:text-white"><i class="fa-regular fa-copy"></i></button>`;
    pre.insertBefore(header, block);
}

function showLoading() {
    const div = document.createElement('div');
    div.id = 'loading';
    div.className = 'flex justify-start w-full mb-6 pl-[48px]';
    div.innerHTML = `<div class="msg-ai p-4 typing flex items-center gap-1 shadow-sm bg-white/60 dark:bg-white/5"><span></span><span></span><span></span></div>`;
    document.getElementById('chatContainer').appendChild(div);
    document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
}

async function handleSend() {
    const text = userInput.value.trim();
    if ((!text && !currentImageBase64) || isGenerating) return;
    
    userInput.value = ''; userInput.style.height = 'auto';
    document.getElementById('sendBtn').disabled = true; isGenerating = true;

    // Fix Prompt for Vision
    let promptData;
    const sysInstruction = "You are XyonGPT by Kasan. Use Indonesian. Analyze image if provided.";
    
    if (currentImageBase64) {
        // Send structured array for vision capability
        promptData = [
            { type: "text", text: `${sysInstruction}\nUser: ${text}` },
            { type: "image_url", image_url: { url: currentImageBase64 } }
        ];
    } else {
        // Send string for text-only
        promptData = `${sysInstruction}\nUser: ${text}`;
    }

    appendMessage('user', text, currentImageBase64);
    const imgToSend = currentImageBase64; removeImage(); showLoading();

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptData })
        });
        const data = await res.json();
        document.getElementById('loading').remove();
        if(data.status && data.data.answer) {
            appendMessage('ai', data.data.answer);
            saveHistory(text, data.data.answer);
        } else {
            appendMessage('ai', 'Error: API Error.');
        }
    } catch (e) {
        document.getElementById('loading')?.remove();
        appendMessage('ai', 'Error: Connection failed.');
    }
    isGenerating = false; document.getElementById('sendBtn').disabled = false;
    userInput.focus();
}

function detectLanguage(text) {
    const indonesianWords = ['adalah', 'yang', 'dan', 'di', 'ke', 'dari', 'ini', 'itu', 'untuk', 'saya', 'kamu', 'halo', 'terima', 'kasih'];
    const words = text.toLowerCase().split(/\s+/);
    let idCount = 0;
    words.forEach(w => { if(indonesianWords.includes(w.replace(/[.,?!]/g, ''))) idCount++; });
    return (idCount / words.length > 0.1) || (idCount > 0 && words.length < 5) ? 'id-ID' : 'en-US';
}

function speak(t) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    const lang = detectLanguage(t);
    u.lang = lang;
    if(lang === 'id-ID') {
        const idVoice = voices.find(v => v.lang.includes('ID') || v.lang.includes('ind'));
        if(idVoice) u.voice = idVoice;
    }
    u.rate = 1.0;
    window.speechSynthesis.speak(u);
}

function saveHistory(u, a) {
    let h = JSON.parse(localStorage.getItem('xyon_history') || '[]');
    h.push({u, a, t: new Date().toLocaleTimeString()});
    localStorage.setItem('xyon_history', JSON.stringify(h));
}
function loadHistory() {
    const list = document.getElementById('historyList');
    const h = JSON.parse(localStorage.getItem('xyon_history') || '[]');
    list.innerHTML = '';
    [...h].reverse().forEach(i => {
        const el = document.createElement('div');
        el.className = 'glass-panel p-4 rounded-xl cursor-pointer hover:border-primary transition-all bg-white/50 dark:bg-white/5 border-transparent shadow-sm group';
        el.innerHTML = `<div class="flex justify-between text-[10px] text-gray-400 mb-2 font-mono"><span>${i.t}</span><i class="fa-solid fa-arrow-right opacity-0 group-hover:opacity-100 transition-opacity text-primary"></i></div><p class="dark:text-gray-200 text-gray-700 text-sm line-clamp-2 font-medium">${i.u}</p>`;
        el.onclick = () => { switchTab('chat'); appendMessage('user', i.u); appendMessage('ai', i.a); };
        list.appendChild(el);
    });
}
function wipeHistory() { localStorage.removeItem('xyon_history'); loadHistory(); }
function copyText(t) { navigator.clipboard.writeText(t); }
function clearChat() { document.getElementById('chatContainer').innerHTML = ''; document.getElementById('chatContainer').appendChild(document.getElementById('welcome')); document.getElementById('welcome').style.display='flex'; }
function presetPrompt(t) { userInput.value = t; userInput.focus(); }
function toggleMic() {
    if(!('webkitSpeechRecognition' in window)) return alert('Not supported');
    const r = new webkitSpeechRecognition(); r.lang = 'id-ID';
    r.onstart = () => document.getElementById('micBtn').classList.add('text-red-500', 'animate-pulse');
    r.onend = () => document.getElementById('micBtn').classList.remove('text-red-500', 'animate-pulse');
    r.onresult = (e) => userInput.value += e.results[0][0].transcript;
    r.start();
}
function exportChat() {
    const h = JSON.parse(localStorage.getItem('xyon_history') || '[]');
    const b = new Blob([h.map(i=>`[${i.t}]\nU: ${i.u}\nA: ${i.a}\n---`).join('\n')],{type:'text/plain'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='xyon_log.txt'; a.click();
}
document.getElementById('chatForm').addEventListener('submit', (e)=>{e.preventDefault(); handleSend()});

function drawNeuralNetwork() {
    const canvas = document.getElementById('neural');
    const ctx = canvas.getContext('2d');
    let w, h, particles = [];
    const color = html.classList.contains('dark') ? 'rgba(99, 102, 241,' : 'rgba(79, 70, 229,';
    const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize); resize();
    class P {
        constructor() { this.x=Math.random()*w; this.y=Math.random()*h; this.vx=(Math.random()-.5)*.3; this.vy=(Math.random()-.5)*.3; }
        update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w) this.vx*=-1; if(this.y<0||this.y>h) this.vy*=-1; }
    }
    particles = Array(50).fill().map(() => new P());
    function animate() {
        ctx.clearRect(0,0,w,h);
        particles.forEach((p, i) => {
            p.update();
            ctx.fillStyle = color + '0.4)'; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
            particles.slice(i+1).forEach(p2 => {
                const d = Math.hypot(p.x-p2.x, p.y-p2.y);
                if(d<140) { ctx.strokeStyle = `${color}${0.08 * (1 - d/140)})`; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
            });
        });
        requestAnimationFrame(animate);
    }
    animate();
}

initTheme();
updateProfileUI();
</script>
</body>
  </html>
